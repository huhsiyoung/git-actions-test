name: Spring Boot CI/CD

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. 소스코드 체크아웃
      - name: Checkout source code
        uses: actions/checkout@v4

      # 2. JDK 17 설치 (Temurin 배포판)
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # 3. Gradle 캐시 설정 (빌드 속도 향상)
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      # 4. gradlew 실행 권한 부여
      - name: Grant execute permission to gradlew
        run: chmod +x gradlew

      # 5. 테스트 실행
      - name: Run tests
        run: ./gradlew test

      # 6. JAR 빌드 (테스트는 위에서 이미 실행했으므로 skip)
      - name: Build JAR
        run: ./gradlew build -x test

      # 7. JAR 파일을 서버로 전송 (SCP)
      - name: Copy JAR to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          source: "build/libs/*.jar"
          target: "/home/${{ secrets.SERVER_USER }}/app/"
          overwrite: true

      # 8. SSH 접속 후 앱 재시작
      - name: Deploy and restart application
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          script: |
            APP_DIR="/home/${{ secrets.SERVER_USER }}/app"
            JAR_FILE=$(ls $APP_DIR/build/libs/*.jar | grep -v plain)
            PID_FILE="$APP_DIR/app.pid"

            echo ">>> 기존 프로세스 종료"
            if [ -f "$PID_FILE" ]; then
              OLD_PID=$(cat "$PID_FILE")
              kill "$OLD_PID" || true
              sleep 2
              rm -f "$PID_FILE"
              echo "PID $OLD_PID 종료 완료"
            else
              echo "실행 중인 프로세스 없음"
            fi

            echo ">>> 새 애플리케이션 시작"
            setsid nohup java -jar $JAR_FILE --spring.profiles.active=prod < /dev/null >> $APP_DIR/app.log 2>&1 &

            NEW_PID=$!
            echo $NEW_PID > "$PID_FILE"
            echo "PID $NEW_PID 으로 시작됨"

            sleep 2
            echo ">>> 실행 중인 프로세스 확인"
            pgrep -f "SNAPSHOT.jar" && echo "✅ 배포 성공" || echo "❌ 프로세스 없음"